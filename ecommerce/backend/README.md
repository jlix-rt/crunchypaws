# üöÄ CrunchyPaws Backend API

API REST para el e-commerce de productos deshidratados para mascotas, construida con Node.js, TypeScript, Express y Prisma.

## üìã Tabla de Contenidos

- [üèóÔ∏è Arquitectura](#Ô∏è-arquitectura)
- [üõ†Ô∏è Tecnolog√≠as](#Ô∏è-tecnolog√≠as)
- [üì¶ Instalaci√≥n](#-instalaci√≥n)
- [üîß Configuraci√≥n](#-configuraci√≥n)
- [üöÄ Desarrollo](#-desarrollo)
- [üì° API Endpoints](#-api-endpoints)
- [üóÑÔ∏è Base de Datos](#Ô∏è-base-de-datos)
- [üß™ Testing](#-testing)
- [üìä Monitoreo](#-monitoreo)
- [üîí Seguridad](#-seguridad)

## üèóÔ∏è Arquitectura

### Patr√≥n de Capas
```
Controllers ‚Üí Services ‚Üí Repositories ‚Üí Database
     ‚Üì           ‚Üì           ‚Üì
Middleware ‚Üê Utils ‚Üê Types
```

### Estructura del Proyecto
```
src/
‚îú‚îÄ‚îÄ controllers/     # Controladores HTTP
‚îú‚îÄ‚îÄ services/       # L√≥gica de negocio
‚îú‚îÄ‚îÄ repositories/   # Acceso a datos
‚îú‚îÄ‚îÄ middleware/     # Middleware Express
‚îú‚îÄ‚îÄ utils/          # Utilidades
‚îú‚îÄ‚îÄ types/          # Tipos TypeScript
‚îú‚îÄ‚îÄ routes/         # Definici√≥n de rutas
‚îú‚îÄ‚îÄ prisma/         # Esquemas y seeds
‚îî‚îÄ‚îÄ __tests__/      # Tests de integraci√≥n
```

## üõ†Ô∏è Tecnolog√≠as

- **Node.js 18+** - Runtime JavaScript
- **TypeScript** - Tipado est√°tico
- **Express** - Framework web
- **Prisma** - ORM y query builder
- **MySQL** - Base de datos
- **Zod** - Validaci√≥n de esquemas
- **JWT** - Autenticaci√≥n
- **bcryptjs** - Hash de contrase√±as
- **Jest + Supertest** - Testing

## üì¶ Instalaci√≥n

```bash
# Instalar dependencias
npm install

# Configurar variables de entorno
cp env.example .env

# Generar cliente Prisma
npm run db:generate

# Aplicar migraciones
npm run db:push

# Ejecutar seeds
npm run db:seed
```

## üîß Configuraci√≥n

### Variables de Entorno (.env)

```bash
# Base de datos
DATABASE_URL="mysql://usuario:contrase√±a@host:puerto/database"

# JWT
JWT_SECRET="clave-super-secreta-cambiar-en-produccion"
JWT_EXPIRES_IN="7d"

# Servidor
PORT=3000
NODE_ENV=development

# WhatsApp
WHATSAPP_PROVIDER=mock          # mock | twilio | meta
WHATSAPP_ENABLED=true
WHATSAPP_FROM=+50200000000
WHATSAPP_TO=+50200000000
WHATSAPP_TOKEN=mock-token
WHATSAPP_NAMESPACE=crunchypaws

# Twilio (si se usa)
TWILIO_ACCOUNT_SID=tu-account-sid
TWILIO_AUTH_TOKEN=tu-auth-token

# Meta WhatsApp (si se usa)
META_ACCESS_TOKEN=tu-access-token
META_PHONE_NUMBER_ID=tu-phone-number-id

# Uploads
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=5242880
```

## üöÄ Desarrollo

### Comandos Disponibles

```bash
# Desarrollo con hot reload
npm run dev

# Build para producci√≥n
npm run build

# Ejecutar build
npm start

# Tests
npm test
npm run test:watch
npm run test:coverage

# Linting y formato
npm run lint
npm run lint:fix
npm run format

# Base de datos
npm run db:generate    # Generar cliente Prisma
npm run db:push       # Aplicar cambios al esquema
npm run db:seed       # Ejecutar seeds
npm run db:reset      # Reset completo
npm run db:studio     # Abrir Prisma Studio
```

### URLs de Desarrollo
- **API**: http://localhost:3000
- **Health Check**: http://localhost:3000/api/health
- **Prisma Studio**: http://localhost:5555

## üì° API Endpoints

### üîê Autenticaci√≥n
```http
POST   /api/auth/register      # Registrar usuario
POST   /api/auth/login         # Iniciar sesi√≥n
GET    /api/auth/me            # Obtener perfil (requiere auth)
PUT    /api/auth/me            # Actualizar perfil (requiere auth)
PUT    /api/auth/change-password # Cambiar contrase√±a (requiere auth)
```

### üõçÔ∏è Productos
```http
GET    /api/products           # Listar productos (con filtros)
GET    /api/products/featured  # Productos destacados
GET    /api/products/search    # Buscar productos
GET    /api/products/:slug     # Obtener producto por slug
GET    /api/products/category/:categorySlug # Productos por categor√≠a
POST   /api/products/check-stock # Verificar stock
```

### üìÇ Categor√≠as
```http
GET    /api/categories         # Listar categor√≠as (√°rbol)
GET    /api/categories/root    # Categor√≠as principales
GET    /api/categories/:slug   # Obtener categor√≠a por slug
GET    /api/categories/:id/subcategories # Subcategor√≠as
GET    /api/categories/:id/path # Ruta de categor√≠a
```

### üõí Carrito
```http
POST   /api/cart/price         # Calcular precios del carrito
POST   /api/cart/validate      # Validar items del carrito
```

### üé´ Cupones
```http
POST   /api/coupons/validate   # Validar cup√≥n
GET    /api/coupons/active     # Cupones activos
GET    /api/coupons/:code      # Obtener cup√≥n por c√≥digo
```

### üì¶ √ìrdenes
```http
POST   /api/orders             # Crear orden
GET    /api/orders/:id         # Obtener orden por ID
GET    /api/orders             # √ìrdenes del usuario (requiere auth)
GET    /api/orders/stats       # Estad√≠sticas de √≥rdenes
PUT    /api/orders/:id/status  # Actualizar estado (admin)
```

### üìç Direcciones
```http
GET    /api/addresses          # Listar direcciones (requiere auth)
GET    /api/addresses/:id      # Obtener direcci√≥n (requiere auth)
POST   /api/addresses          # Crear direcci√≥n (requiere auth)
PUT    /api/addresses/:id      # Actualizar direcci√≥n (requiere auth)
DELETE /api/addresses/:id      # Eliminar direcci√≥n (requiere auth)
PATCH  /api/addresses/:id/default # Marcar como predeterminada (requiere auth)
```

### üí≥ Pagos
```http
GET    /api/payments/methods   # M√©todos de pago disponibles
POST   /api/payments/intent    # Crear intenci√≥n de pago
POST   /api/payments/confirm   # Confirmar pago
GET    /api/payments/status/:id # Estado del pago
POST   /api/payments/webhook   # Webhook de procesador
```

### üìû Contacto
```http
POST   /api/contact            # Enviar mensaje de contacto
GET    /api/contact            # Listar mensajes (admin)
GET    /api/contact/stats      # Estad√≠sticas de contacto (admin)
GET    /api/contact/:id        # Obtener mensaje (admin)
DELETE /api/contact/:id        # Eliminar mensaje (admin)
```

### ‚öôÔ∏è Configuraci√≥n
```http
GET    /api/config/whatsapp    # Configuraci√≥n WhatsApp (admin)
PUT    /api/config/whatsapp    # Actualizar WhatsApp (admin)
POST   /api/config/whatsapp/test # Probar conexi√≥n WhatsApp (admin)
GET    /api/config/general     # Configuraci√≥n general (admin)
PUT    /api/config/general     # Actualizar configuraci√≥n (admin)
DELETE /api/config/general/:scope/:key # Eliminar configuraci√≥n (admin)
```

### üè• Salud
```http
GET    /api/health             # Estado de la API
```

## üóÑÔ∏è Base de Datos

### Modelo de Datos

#### Usuarios y Autenticaci√≥n
- **User**: Informaci√≥n del usuario
- **UserAddress**: Direcciones del usuario

#### Cat√°logo
- **Category**: Categor√≠as jer√°rquicas
- **Product**: Productos del cat√°logo

#### √ìrdenes y Pagos
- **Order**: √ìrdenes de compra
- **OrderItem**: Items de las √≥rdenes
- **PaymentMethod**: M√©todos de pago disponibles

#### Marketing
- **Coupon**: Cupones de descuento

#### Comunicaci√≥n
- **ContactMessage**: Mensajes de contacto

#### Configuraci√≥n
- **Config**: Configuraciones del sistema

### Relaciones Principales
```sql
User 1:N UserAddress
User 1:N Order
Category 1:N Category (self-reference)
Category 1:N Product
Order 1:N OrderItem
Product 1:N OrderItem
```

### Seeds Incluidos
- Categor√≠as de ejemplo (Perro, Gato con subcategor√≠as)
- Productos demo con im√°genes
- M√©todos de pago (Tarjeta, Efectivo, Transferencia)
- Usuario demo: `demo@crunchypaws.com` / `password123`
- Cupones de ejemplo
- Configuraci√≥n inicial de WhatsApp

## üß™ Testing

### Estructura de Tests
```
src/
‚îú‚îÄ‚îÄ __tests__/
‚îÇ   ‚îú‚îÄ‚îÄ integration/    # Tests de integraci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ unit/          # Tests unitarios
‚îú‚îÄ‚îÄ controllers/__tests__/
‚îú‚îÄ‚îÄ services/__tests__/
‚îî‚îÄ‚îÄ test/
    ‚îî‚îÄ‚îÄ setup.ts       # Configuraci√≥n de tests
```

### Ejecutar Tests
```bash
# Todos los tests
npm test

# Tests en modo watch
npm run test:watch

# Coverage report
npm run test:coverage

# Tests espec√≠ficos
npm test -- --testNamePattern="Auth"
```

### Cobertura Objetivo
- **Statements**: >80%
- **Branches**: >80%
- **Functions**: >80%
- **Lines**: >80%

### Tests Implementados

#### Unitarios
- **AuthController**: Registro, login, perfil
- **NotificationService**: Env√≠o de WhatsApp
- **Repositories**: CRUD operations
- **Utils**: JWT, validaci√≥n, respuestas

#### Integraci√≥n
- **Auth endpoints**: Flujo completo de autenticaci√≥n
- **Health check**: Verificaci√≥n de estado
- **Orders**: Creaci√≥n y gesti√≥n de √≥rdenes
- **Cart**: C√°lculos y validaciones

## üìä Monitoreo

### Health Check
```bash
curl http://localhost:3000/api/health
```

Respuesta:
```json
{
  "status": "OK",
  "timestamp": "2023-12-01T10:00:00.000Z",
  "uptime": 3600,
  "environment": "development"
}
```

### Logs
El sistema utiliza un logger estructurado que incluye:
- **Timestamp**: Fecha y hora del evento
- **Level**: ERROR, WARN, INFO, DEBUG
- **Message**: Descripci√≥n del evento
- **Metadata**: Informaci√≥n adicional contextual

Configuraci√≥n de niveles por environment:
- **Development**: DEBUG
- **Production**: INFO
- **Test**: ERROR

### M√©tricas Disponibles
- Tiempo de respuesta de endpoints
- Errores por tipo y frecuencia
- Uso de memoria y CPU
- Conexiones a base de datos
- Rate limiting por IP

## üîí Seguridad

### Implementaciones de Seguridad

#### Autenticaci√≥n y Autorizaci√≥n
- **JWT Tokens** con expiraci√≥n configurable
- **Bcrypt** para hash de contrase√±as (salt rounds: 10)
- **Guards** para rutas protegidas
- **Role-based access** (preparado para expansi√≥n)

#### Validaci√≥n y Sanitizaci√≥n
- **Zod schemas** para validaci√≥n de entrada
- **SQL Injection** prevenido por Prisma ORM
- **XSS Protection** con sanitizaci√≥n de datos
- **Input validation** en todos los endpoints

#### Rate Limiting
```typescript
// Configuraciones por endpoint
/api/*          ‚Üí 100 req/15min por IP
/api/auth/*     ‚Üí 5 req/15min por IP
/api/contact    ‚Üí 3 req/1h por IP
/api/orders     ‚Üí 10 req/1h por IP
```

#### Headers de Seguridad
- **Helmet** para headers est√°ndar
- **CORS** configurado por environment
- **Content Security Policy**
- **X-Frame-Options**: SAMEORIGIN
- **X-XSS-Protection**: 1; mode=block

#### Logging de Seguridad
- Intentos de login fallidos
- Accesos no autorizados
- Rate limiting triggers
- Errores de validaci√≥n

### Recomendaciones para Producci√≥n

#### Variables de Entorno
```bash
# JWT con clave robusta (256+ bits)
JWT_SECRET="clave-super-segura-generada-aleatoriamente"

# Base de datos con usuario espec√≠fico
DATABASE_URL="mysql://app_user:password_seguro@db:3306/crunchypaws"

# Logs en nivel INFO
LOG_LEVEL=INFO
```

#### Infraestructura
- **HTTPS** obligatorio con certificados v√°lidos
- **WAF** (Web Application Firewall)
- **Database encryption** at rest
- **Backup autom√°tico** con retenci√≥n
- **Monitoring** con alertas

#### Auditor√≠a
- **Log aggregation** (ELK Stack, Splunk)
- **Security scanning** (Snyk, OWASP ZAP)
- **Dependency updates** automatizadas
- **Penetration testing** peri√≥dico

## üöÄ Deployment

### Build para Producci√≥n
```bash
# Build optimizado
npm run build

# Verificar build
node dist/index.js
```

### Docker
```bash
# Build imagen
docker build -t crunchypaws-backend .

# Run container
docker run -p 3000:3000 \
  -e DATABASE_URL="mysql://..." \
  -e JWT_SECRET="..." \
  crunchypaws-backend
```

### Variables de Entorno Cr√≠ticas
- `DATABASE_URL`: Conexi√≥n a base de datos
- `JWT_SECRET`: Clave para tokens JWT
- `NODE_ENV=production`: Modo producci√≥n
- `PORT`: Puerto del servidor (default: 3000)

### Health Checks
```bash
# Kubernetes/Docker health check
curl -f http://localhost:3000/api/health || exit 1
```

## ü§ù Contribuci√≥n

### Est√°ndares de C√≥digo
- **TypeScript strict mode** habilitado
- **ESLint** con reglas estrictas
- **Prettier** para formateo consistente
- **Conventional Commits** para mensajes

### Flujo de Desarrollo
1. Crear feature branch
2. Implementar funcionalidad
3. Escribir tests (unitarios + integraci√≥n)
4. Verificar cobertura >80%
5. Lint y format
6. Commit con formato convencional
7. Push y crear PR

### Comandos Pre-commit
```bash
npm run lint:fix
npm run format
npm run test
```

## üìö Recursos Adicionales

- **Prisma Docs**: https://www.prisma.io/docs
- **Express.js**: https://expressjs.com
- **TypeScript**: https://www.typescriptlang.org
- **Jest Testing**: https://jestjs.io
- **Zod Validation**: https://zod.dev

---

**API desarrollada con ‚ù§Ô∏è para CrunchyPaws üêæ**
